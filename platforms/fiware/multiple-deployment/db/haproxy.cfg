global
    log /dev/log local0
    maxconn 4096

defaults
    log global
    mode tcp
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    retries 3

#---------------------------------------------------------
# CRITICAL FIX: Simple Working Configuration First
#---------------------------------------------------------

# Main frontend for MongoDB traffic (port 27019) - SIMPLIFIED
frontend mongodb_frontend
    bind *:27019
    mode tcp
    option tcplog
    # REMOVED COMPLEX ACLs THAT BREAK CONNECTIONS
    default_backend mongodb_write_backend

# Write Backend - Primary MongoDB instance (mongo1) - SIMPLIFIED
backend mongodb_write_backend
    mode tcp
    balance roundrobin
    # REMOVED COMPLEX TCP-CHECKS THAT BREAK CONNECTIONS
    server mongo1 mongo1:27017 check
    server mongo2 mongo2:27017 check backup
    server mongo3 mongo3:27017 check backup

# SEPARATE PORTS FOR MANUAL CONTROL
frontend mongodb_write_frontend
    bind *:27020
    mode tcp
    option tcplog
    default_backend mongodb_write_only_backend

frontend mongodb_read_frontend
    bind *:27021
    mode tcp
    option tcplog
    default_backend mongodb_read_only_backend

# Write-only backend
backend mongodb_write_only_backend
    mode tcp
    balance roundrobin
    server mongo1 mongo1:27017 check

# Read-only backend  
backend mongodb_read_only_backend
    mode tcp
    balance roundrobin
    server mongo2 mongo2:27017 check
    server mongo3 mongo3:27017 check

# Your original working configuration (port 27022)
frontend mongodb_legacy_front
    bind *:27022
    mode tcp
    option tcplog
    default_backend mongodb_legacy_back

backend mongodb_legacy_back
    mode tcp
    balance roundrobin
    server mongo1 mongo1:27017 check
    server mongo2 mongo2:27017 check
    server mongo3 mongo3:27017 check

# OPTIONAL: Stats page (if needed)
listen mongodb_stats
    bind *:8404
    mode http
    stats enable
    stats uri /haproxy-stats
    stats auth admin:mongopass123

#---------------------------------------------------------
# CRITICAL DEBUGGING NOTES:
#---------------------------------------------------------

# The problems were:
# 1. Complex ACL payload inspection breaks MongoDB connections
# 2. Binary tcp-check commands are malformed and cause connection issues
# 3. tune.maxaccept can cause connection problems in some environments
# 4. Long timeouts (300s) can cause hanging behavior

# SOLUTION:
# Use port 27019: Basic load balancing with failover (mongo1 primary, others backup)
# Use port 27020: Write-only (mongo1)
# Use port 27021: Read-only (mongo2, mongo3)
# Use port 27022: Your original working configuration

# TEST CONNECTIONS:
# mongo --host your_ip:27019  (should work immediately)
# mongo --host your_ip:27022  (your original - should work)

#---------------------------------------------------------
